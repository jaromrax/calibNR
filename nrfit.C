/*
 *   nrfit.C    
 *
 *   nuclear reaction  fit
 *    - takes into account kinematics, losses
 *
 *    - can fit experiental channels to energy
 *      and search for minimum CHi2 by variation of different
 *      components (beam energy, target thickness...)
 *
 */

#include "losslib2.h"
#include "manip_table.h"


void nrfit(const char* filename){
  int i;
  double d;
  //printf("http://picascii.com/\n"); //while read line; do echo printf\(\"$line\\n\"\)\;; done < asciart2.txt
printf("                                                                                                    \n");
printf("                                                                                                    \n");
printf("                                                                                                    \n");
printf("                                                                                                    \n");
printf("                                                                                                    \n");
printf("                                                                                                    \n");
printf("                                                                                                    \n");
printf("                                                                   `    ,                           \n");
printf("                                                                ```    `                            \n");
printf("                                                    .     ``.`` `  ``````..` ``                     \n");
printf("                                                 .     `.````````.````...,,`,..````                 \n");
printf("                                                    ```````.`` ``````````````...`.``..`             \n");
printf("                                                 ``````````` ``````````````````````.:.. `           \n");
printf("                                              ``````````````.,,,,...``.`...`.`````  ```.``          \n");
printf("                                             ..`````````.,,.`.`````````````.....```   ```.`         \n");
printf("                                            ``````````,,.,.`..`..```````` ``...,````   `:`.`        \n");
printf("                                      `` ``````.``.,,,..,:,::;::::,,.````````,,.,.``      `. `      \n");
printf("                                      ` ````.``..,.,::;:::;:;,,;::,,,,:,.`````..,..       `.``      \n");
printf("                                    `.`````....:,:::;:+::;:;,,,:,.,.,,,,,,``````..``       `,`      \n");
printf("                                  ```.```.,...,;:;+:;;+:::;;+:;;,.`....:,..```````,```       `      \n");
printf("                                ````````....:;:;::+++:::;;::;:##:;.``...,,.``````..,```      `      \n");
printf("                               ````````.:`,::+:++#+###++:+:;;;+#:+..``..,:,`````` ,.,```     ``     \n");
printf("                             `````````..`,+;::+#@##@#@@#+#::,;:;::,,...,.::````````.`,``      `     \n");
printf("                           ```.``.``...`,;+;:+@@+@@#@#@@##::,,#:;;;,.``..:,```````.,,` `      `     \n");
printf("                            ``,`````.,.,:;;;;#@@@@@##@@@@@#;:,;;;::,``.,.,..``````..,`        `.    \n");
printf("                          `.`...```:,..:+#:;+#@@@#@@@@##@+::,::;+:,.```.,::```````````        `     \n");
printf("                         `,```.```.,,.,;+#:+:#@#@@@@@###+++;:::::;:`````.,,,``````...`              \n");
printf("                       ```.``.```.:,,,:;:+++:#@@@@@@@@#####;::::,,.````..::.```` ...````            \n");
printf("                        `.```.```,;:::::;+:#####@@@@@@@###:::::::,..```..,:.```````;````            \n");
printf("                        .```..```,::::::;;:+##@#@@@@@@@###+:,:;:,.``.`..,:..``````,.```             \n");
printf("                       ````.,.```.::;::::;;:#+#@#@@@@@###+::,:;,```````::,`````````.                \n");
printf("                      `.```...```.:;;;;;:;;;+#+@@##@##@#:;:;;,:`.````:.:;.`` `  ,,,`                \n");
printf("                     `````,,:.````,,;:;::;:::::######+:;::;;:.,.`````;::.```  ` ````                \n");
printf("                     .,```.:;..``....,;:;;;:::;:###::;:;:::::...```..,:.````  ```.,                 \n");
printf("                     ```` `.:.....`....,,:,,,;;;:::;;;;::::::,````.,:,.````    ,`;```.              \n");
printf("                    `..````.::;,,...,.....,::::;:;;::;::::,,..```.:,,.```    ````,                  \n");
printf("                    `,.`````;,,::;:::,:,,,::,,,,,,:::;+;:+..````.,:...``   ````` `                  \n");
printf("                   `.,,`````...::;,::;#;:;:::,,.,,;;:;:,,..`````.:..````   ```.``                   \n");
printf("                   ``::.````````..,,,,:,.,:..,..:::::,,,.`````.`..````    ```.` `                   \n");
printf("                   ``:;,.``````````.``````......`,,..`..````.``..,.``` `````:`.`                    \n");
printf("               .   ``.:,,``````````````````.........``` ````.,,...```  ```..:`                      \n");
printf("               `   ``.;:;,`.`````````....`..,,,..,``````````.`,...``  ````.``                       \n");
printf("              ``   ```..:+:,..``..,,,,.,,,,,;,,..````````````..`.` `````.,.``                       \n");
printf("               ` `   `.,.,:,,.....,#,::::,,,.,```````````,:``,```` ````````                         \n");
printf("               .`` ` ``..`,,`..,.,,.:.`.`````````````````...````  ``````` `                         \n");
printf("              `.,``` ````````..:...;` ```````````````.```.````  ``````,:                            \n");
printf("                ,,     ``````````..```````````.````.`.,`.``    ` `` . .`                            \n");
printf("                .,`    `````````````````````....`.....,```     `````,`,`                            \n");
printf("                 `,;```  `````````````````......,````.``   ````   `   ``                            \n");
printf("                  `,,.:. `` `````````````..`...````````  ``````````.` `;                            \n");
printf("                  ````...````````````.,...`.``````  ``  ```````` ` `   `                            \n");
printf("                    ```,,...`...``..,`.`````` ``      `` ```,````                                   \n");
printf("                       `.```:.``,``..`````                ` ``                                      \n");
printf("                           ``.     ``````.           ```````                                        \n");
printf("                                    ```          ` ` `,` `    `                                     \n");
printf("                                                  `  ```     ``                                     \n");
printf("                                                ``````                                              \n");
printf("                                            ` ``   `                                                \n");
printf("                                              ``   `                                                \n");
printf("                                            `                                                       \n");
printf("                                          `                                                         \n");
printf("                                            `                                                       \n");
printf("                                                                                                    \n");
printf("                                                                                                    \n");
printf("                                                                                                    \n");
printf("\n");


 for (int i=0;i<MAXLINES;i++){ linecanv[i]=NULL; }// we remove all canvases
  
  // PARSE THE table first   
  i=readout_reac_file(filename, 0 ); 
  if (i!=0){ printf("Error in analyze_react1 ... STOP%s\n","");return;}

  printf("\n+ ... %s\n","process FORMULAS to VALUES to varnames in table (A,Z list...)");

  i=interpolate_varnames_in_table();
  if (i!=0){ printf("%s\n","Problem during 1st parsing the table.STOP");return;}

  printf("i ... table : prepared\ni ... structure : prepared\ni ... loss tables : loaded%s\n","" );


  printf("\n\n+ ... %s\n","do kinematics NOW: ==================================");
  //  preprocess_table();
  d=do_kinematics(1);
  //  printf("total ch2=%lf\n", d );
  printf("+ ... %s\n","DO LINEAR CALIBRATION ===============================");
 


  CANVMAIN=(TCanvas*)gROOT->GetListOfCanvases()->FindObject("nrfit");
  if (CANVMAIN==NULL){
    CANVMAIN=new TCanvas("nrfit","nrfit");
    CANVMAIN->Draw();
  }
  lincal();

  //  d=do_kinematics(0);
  //  printf("total ch2=%lf\n", d );




}//nrfit=========================================== MAIN END =====
